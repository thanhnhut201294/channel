<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok Multi-Channel Analyzer V4.1</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&family=Fredoka:wght@600&display=swap" rel="stylesheet">

  <style>
    :root {
      /* B·∫£ng m√†u Neubrutalism */
      --primary: #ff0050;      
      --secondary: #00f2ea;    
      --bg-color: #f0f4f8;     
      --border-color: #000000; 
      --card-bg: #ffffff;
      --text-color: #000000;
      
      /* Style Config */
      --hard-shadow: 8px 8px 0px var(--border-color);
      --btn-shadow: 4px 4px 0px var(--border-color);
      --input-shadow: 2px 2px 0px var(--border-color);
      --border-thick: 3px solid var(--border-color);
      --border-thin: 2px solid var(--border-color);
      --radius-xl: 15px;
      --radius-md: 10px;
      --radius-pill: 50px;
    }

    body { 
      font-family: 'Be Vietnam Pro', sans-serif; 
      padding: 20px; 
      background: var(--bg-color); 
      color: var(--text-color); 
      background-image: radial-gradient(#000 1px, transparent 1px);
      background-size: 20px 20px;
    }

    button, input, textarea, table, th, td, span, label, small, a {
      font-family: 'Be Vietnam Pro', sans-serif !important;
    }

    /* N√∫t Quay l·∫°i (B√™n ph·∫£i) */
    .nav-top {
      max-width: 1400px;
      margin: 0 auto 20px auto;
      display: flex;
      justify-content: flex-end;
    }
    
    .btn-home {
      text-decoration: none;
      background: #ffffff;
      color: #000;
      font-weight: 700;
      font-size: 15px;
      padding: 10px 24px;
      border: var(--border-thick);
      border-radius: var(--radius-pill);
      box-shadow: var(--btn-shadow);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.1s ease;
    }
    .btn-home:hover {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0px var(--border-color);
      background: #fff;
    }
    .btn-home:active {
      transform: translate(2px, 2px);
      box-shadow: 0px 0px 0px var(--border-color);
    }
    .icon-back {
      font-weight: 900;
      font-size: 18px;
      line-height: 1;
      transform: translateY(-1px);
    }

    /* Khung ch√≠nh */
    main { 
      max-width: 1400px; 
      margin: 0 auto; 
      background: var(--card-bg); 
      padding: 30px; 
      border-radius: var(--radius-xl); 
      border: var(--border-thick);
      box-shadow: var(--hard-shadow);
    }
    
    h1 { 
      font-family: 'Fredoka', cursive !important;
      font-size: 2.5rem;
      margin-top: 0; 
      text-align: center; 
      color: var(--primary); 
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 30px;
      text-shadow: 2px 2px 0px #000;
      -webkit-text-stroke: 1px black;
    }
    
    .control-panel { 
      display: grid; 
      grid-template-columns: 1fr 320px; 
      gap: 25px; 
      margin-bottom: 30px; 
    }
    
    .input-section { display: flex; flex-direction: column; gap: 10px; }
    
    textarea, input[type="number"] { 
      width: 100%; 
      padding: 15px; 
      border: var(--border-thin); 
      border-radius: var(--radius-md); 
      box-shadow: var(--input-shadow);
      font-size: 15px;
      box-sizing: border-box;
      transition: 0.2s;
    }
    textarea:focus, input:focus { 
      outline: none; 
      background: #f0fbff;
      transform: translate(-1px, -1px);
      box-shadow: 4px 4px 0px var(--border-color);
    }
    textarea { height: 140px; resize: vertical; }
    
    .settings-section { 
      background: #fff5f5;
      padding: 20px; 
      border-radius: var(--radius-md); 
      border: var(--border-thin); 
      box-shadow: var(--input-shadow);
      display: flex; 
      flex-direction: column; 
      gap: 15px; 
    }
    
    label { 
      font-weight: 700; 
      font-size: 16px; 
      color: #000; 
      display: block; 
      margin-bottom: 8px; 
    }

    .btn-group { display: flex; flex-direction: column; gap: 12px; margin-top: auto; }
    
    button { 
      padding: 12px 20px; 
      border: var(--border-thin); 
      border-radius: var(--radius-md); 
      cursor: pointer; 
      font-weight: 700; 
      font-size: 16px; 
      color: #000; 
      transition: all 0.1s; 
      box-shadow: 3px 3px 0px #000;
      text-transform: uppercase;
    }
    button:hover:not(:disabled) {
      transform: translate(-2px, -2px);
      box-shadow: 5px 5px 0px var(--border-color);
    }
    
    #analyzeBtn { background: var(--secondary); }
    #stopBtn { background: var(--primary); color: #fff; display: none; }
    #exportBtn { background: #ffbd00; }
    #exportBtn:disabled { background: #e0e0e0; color: #888; cursor: not-allowed; box-shadow: none; transform: none;}

    .progress-container { 
      height: 20px; 
      background: #fff; 
      border: var(--border-thin); 
      border-radius: 20px; 
      margin: 20px 0; 
      overflow: hidden; 
      display: none; 
      box-shadow: var(--input-shadow);
    }
    .progress-bar { 
      height: 100%; 
      background: repeating-linear-gradient(45deg, var(--secondary), var(--secondary) 10px, #00c4bd 10px, #00c4bd 20px);
      width: 0%; 
      transition: width 0.3s ease; 
      border-right: 2px solid #000;
    }

    #status { 
      font-weight: 600;
      font-size: 14px; 
      color: #000; 
      margin-bottom: 15px; 
      min-height: 20px; 
      padding: 10px;
      background: #e8e8e8;
      border: 1px solid #000;
      border-radius: 6px;
    }

    /* Table Styles */
    .table-container { 
      overflow-x: auto; 
      border: var(--border-thin); 
      border-radius: var(--radius-md); 
      margin-top: 20px; 
      box-shadow: var(--input-shadow);
      background: #fff;
    }
    table { width: 100%; border-collapse: collapse; min-width: 1200px; font-size: 14px; }
    
    /* Sortable Headers */
    th { 
      background: var(--secondary); 
      color: #000; 
      padding: 12px; 
      text-align: left; 
      white-space: nowrap; 
      position: sticky; 
      top: 0; 
      z-index: 10; 
      border-bottom: var(--border-thin);
      border-right: 1px solid #000;
      font-weight: 700;
      font-size: 15px;
      user-select: none;
    }
    th.sortable {
      cursor: pointer;
      transition: background 0.2s;
    }
    th.sortable:hover {
      background: #00c4bd;
    }
    .sort-icon {
      font-size: 12px;
      margin-left: 5px;
      opacity: 0.5;
    }
    th.sorted-asc .sort-icon { opacity: 1; content: '‚ñ≤'; }
    th.sorted-desc .sort-icon { opacity: 1; content: '‚ñº'; }

    td { 
      border-bottom: 1px solid #000; 
      border-right: 1px solid #000;
      padding: 10px 12px; 
      vertical-align: middle; 
      color: #000; 
      font-weight: 500;
    }
    td:last-child, th:last-child { border-right: none; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #fffde7; }

    /* New User Cell Style */
    .user-link {
      text-decoration: none;
      color: inherit;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 5px;
      border-radius: 8px;
      transition: background 0.1s;
    }
    .user-link:hover {
      background: rgba(0,0,0,0.05);
    }
    
    .avatar-img { 
      width: 45px; 
      height: 45px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 2px solid #000; 
      background: #fff;
      flex-shrink: 0;
    }
    
    .user-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .user-name {
      font-weight: 800;
      font-size: 14px;
      line-height: 1.2;
    }
    .user-handle {
      font-size: 12px;
      color: #666;
      line-height: 1.4;
    }

    /* Column Specifics */
    .val-highlight { color: #0075ff; font-weight: 700; } 
    .val-super { color: #d63384; font-weight: 800; } 
    .val-percent { color: #198754; font-weight: 700; background: #e6f7ed; padding: 2px 6px; border-radius: 6px; border: 1px solid #000; }
    
    .status-badge { 
      padding: 4px 8px; 
      border-radius: 20px; 
      font-size: 11px; 
      font-weight: 800; 
      text-transform: uppercase; 
      border: 2px solid #000;
      box-shadow: 2px 2px 0px rgba(0,0,0,0.2);
    }
    .status-ok { background: #88ff8c; color: #000; }
    .status-err { background: #ff8888; color: #000; }
    .status-wait { background: #fff3cd; color: #000; }

    @media (max-width: 768px) {
      .control-panel { grid-template-columns: 1fr; }
      h1 { font-size: 1.8rem; }
      main { padding: 15px; }
      .btn-group { flex-direction: row; }
      .nav-top { justify-content: center; }
    }
  </style>
</head>
<body>

  <div class="nav-top">
    <a href="https://thanhnhut201294.github.io/tool/" class="btn-home">
      <span class="icon-back">‚Ü©</span> Quay l·∫°i trang ch·ªß
    </a>
  </div>

<main>
  <h1>üìà TikTok Analyzer V4.1 (Lite)</h1>

  <div class="control-panel">
    <div class="input-section">
      <label>Danh s√°ch Link K√™nh ho·∫∑c Username (M·ªói d√≤ng 1 k√™nh)</label>
      <textarea id="channelInput" placeholder="V√≠ d·ª•:&#10;https://www.tiktok.com/@vtv24news&#10;@mixigaming&#10;theanh28entertainment..."></textarea>
    </div>

    <div class="settings-section">
      <div>
        <label>S·ªë l∆∞·ª£ng video</label>
        <input type="number" id="limitInput" value="10" min="1" max="48">
        <small style="color: #000; font-weight: 600; font-size: 12px; display:block; margin-top:8px">‚ÑπÔ∏è M·∫∑c ƒë·ªãnh 10 video (Max 48).</small>
      </div>
      
      <div class="btn-group">
        <button id="analyzeBtn">üöÄ Qu√©t D·ªØ Li·ªáu</button>
        <button id="stopBtn">‚èπ D·ª´ng L·∫°i</button>
        <button id="exportBtn" disabled>üì• Xu·∫•t Excel</button>
      </div>
    </div>
  </div>

  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div id="status">S·∫µn s√†ng. H√£y nh·∫≠p ID v√† b·∫•m Qu√©t.</div>

  <div class="table-container">
    <table id="resultTable">
      <thead>
        <tr>
          <th width="3%">#</th>
          <th width="25%">K√™nh (Info)</th> 
          <th width="5%">Videos</th>
          
          <th width="10%" class="sortable" onclick="handleSort('totalView')">T.View <span class="sort-icon">‚áÖ</span></th>
          <th width="10%" class="sortable" onclick="handleSort('avgView')">TB View <span class="sort-icon">‚áÖ</span></th>
          
          <th width="10%" class="sortable" onclick="handleSort('totalInteraction')">T.T√°c <span class="sort-icon">‚áÖ</span></th>
          <th width="10%" class="sortable" onclick="handleSort('avgInteraction')">TB T.T√°c <span class="sort-icon">‚áÖ</span></th>
          <th width="8%" class="sortable" onclick="handleSort('engagementRate')">% T.T√°c <span class="sort-icon">‚áÖ</span></th>

          <th width="8%">T.Cmt</th>
          <th width="8%">TB Cmt</th>
          
          <th width="7%">Status</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>
  <div style="margin-top: 15px; font-size: 13px; font-weight: bold; color: #555;">
    * B·∫•m v√†o ti√™u ƒë·ªÅ c·ªôt ƒë·ªÉ S·∫Øp x·∫øp (TƒÉng/Gi·∫£m).
  </div>
</main>

<script>
  // === CONFIG & UTILS ===
  const PROXY_LIST = [
    { url: 'https://api.codetabs.com/v1/proxy?quest=', type: 'direct' },
    { url: 'https://api.allorigins.win/get?url=', type: 'wrapped' },
    { url: 'https://corsproxy.io/?', type: 'direct' }
  ];

  let isRunning = false;
  let resultsData = [];
  let currentSort = { col: null, dir: 'desc' }; 

  function log(msg) {
    document.getElementById('status').textContent = msg;
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  function extractUsername(input) {
    input = input.trim();
    try {
      if (input.includes('tiktok.com')) {
        const match = input.match(/@([a-zA-Z0-9_.]+)/);
        return match ? match[1] : null;
      }
      if (input.startsWith('@')) return input.substring(1);
      return input;
    } catch (e) {
      return null;
    }
  }

  // === FETCH ENGINE ===
  async function smartFetch(targetUrl) {
    for (const proxy of PROXY_LIST) {
      try {
        const finalUrl = proxy.url + encodeURIComponent(targetUrl);
        const res = await fetch(finalUrl);
        if (!res.ok) throw new Error('Network Error');
        
        let data;
        if (proxy.type === 'wrapped') {
          const temp = await res.json();
          if(!temp.contents) throw new Error("No contents");
          data = JSON.parse(temp.contents);
        } else {
          data = await res.json();
        }
        if (data.code === -1) throw new Error("Limit Reached");
        return data; 
      } catch (e) {
        continue;
      }
    }
    throw new Error("Connection failed");
  }

  async function fetchUserVideos(username, limit) {
    const allVideos = [];
    let cursor = 0;
    let hasMore = true;
    if (limit > 48) limit = 48;

    while (hasMore && allVideos.length < limit) {
      const targetUrl = `https://www.tikwm.com/api/user/posts?unique_id=${username}&count=33&cursor=${cursor}`;
      const data = await smartFetch(targetUrl);

      if (!data?.data?.videos) {
        if (allVideos.length === 0) throw new Error('Private/Not Found');
        break;
      }
      for (const v of data.data.videos) {
        if (allVideos.length >= limit) break;
        allVideos.push(v);
      }
      cursor = data.data.cursor;
      hasMore = data.data.hasMore;
      if (hasMore) await sleep(800); 
    }
    return allVideos;
  }

  // === MAIN LOGIC ===
  document.getElementById('analyzeBtn').addEventListener('click', async () => {
    const inputRaw = document.getElementById('channelInput').value;
    const limit = parseInt(document.getElementById('limitInput').value) || 10;
    
    const lines = inputRaw.split('\n').filter(line => line.trim() !== '');
    const usernames = [...new Set(lines.map(extractUsername).filter(u => u))]; 

    if (usernames.length === 0) return alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 link k√™nh ho·∫∑c username!');

    isRunning = true;
    resultsData = [];
    currentSort = { col: null, dir: 'desc' };
    
    const tbody = document.querySelector('tbody');
    tbody.innerHTML = '';
    
    document.getElementById('analyzeBtn').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'inline-block';
    document.getElementById('exportBtn').disabled = true;
    document.querySelector('.progress-container').style.display = 'block';
    updateProgress(0, usernames.length);

    for (let i = 0; i < usernames.length; i++) {
      if (!isRunning) break;

      const user = usernames[i];
      log(`‚è≥ ƒêang x·ª≠ l√Ω [${i+1}/${usernames.length}]: ${user}...`);
      
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td colspan="10" class="status-badge status-wait" style="text-align:center">ƒêang t·∫£i d·ªØ li·ªáu...</td>`;
      tbody.appendChild(tr);

      try {
        // Ch·ªâ l·∫•y Video, kh√¥ng g·ªçi API User Info ri√™ng n·ªØa
        const videos = await fetchUserVideos(user, limit);
        const stats = calculateStats(videos);
        
        // L·∫•y th√¥ng tin t√°c gi·∫£ t·ª´ video ƒë·∫ßu ti√™n
        const author = videos[0]?.author;

        const finalData = {
          id: i + 1,
          user: user,
          nickname: author?.unique_id || user,
          displayName: author?.nickname || user,
          avatar: author?.avatar || '',
          ...stats,
          status: 'OK'
        };

        resultsData.push(finalData);
        renderSingleRow(tr, finalData);
        
      } catch (error) {
        const errorData = {
           id: i + 1, user: user, status: 'Error', errorMsg: error.message,
           totalView: 0, avgView: 0, totalInteraction: 0
        };
        resultsData.push(errorData);
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${user}</td>
          <td colspan="9" style="color:red; font-weight:bold;">L·ªói: ${error.message}</td>
          <td><span class="status-badge status-err">FAIL</span></td>
        `;
      }

      updateProgress(i + 1, usernames.length);
      if (i < usernames.length - 1) await sleep(1000); 
    }

    finishProcess();
  });

  document.getElementById('stopBtn').addEventListener('click', () => {
    isRunning = false;
    log('‚õî ƒê√£ d·ª´ng.');
    finishProcess();
  });

  function finishProcess() {
    isRunning = false;
    document.getElementById('analyzeBtn').style.display = 'inline-block';
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('exportBtn').disabled = false;
    log('‚úÖ Ho√†n t·∫•t.');
  }

  function updateProgress(current, total) {
    const percent = (current / total) * 100;
    document.getElementById('progressBar').style.width = `${percent}%`;
  }

  function calculateStats(videos) {
    let totalView = 0, totalLike = 0, totalCmt = 0, totalShare = 0, totalSave = 0;
    videos.forEach(v => {
      totalView += (v.play_count || 0);
      totalLike += (v.digg_count || 0);
      totalCmt  += (v.comment_count || 0);
      totalShare += (v.share_count || 0);
      totalSave += (v.collect_count || 0);
    });

    const count = videos.length;
    const totalInteraction = totalLike + totalCmt + totalShare + totalSave;
    
    return {
      count,
      totalView,
      avgView: count ? Math.round(totalView / count) : 0,
      totalCmt,
      avgCmt: count ? Math.round(totalCmt / count) : 0,
      cmtRate: totalView > 0 ? ((totalCmt / totalView) * 100).toFixed(2) : 0,
      totalInteraction,
      avgInteraction: count ? Math.round(totalInteraction / count) : 0,
      engagementRate: totalView > 0 ? ((totalInteraction / totalView) * 100).toFixed(2) : 0
    };
  }

  // === RENDERING & SORTING ===
  
  function renderSingleRow(tr, d) {
    tr.innerHTML = `
      <td>${d.id}</td>
      <td>
        <a href="https://www.tiktok.com/@${d.nickname}" target="_blank" class="user-link">
          <img src="${d.avatar}" class="avatar-img" onerror="this.src='https://via.placeholder.com/50'">
          <div class="user-info">
            <div class="user-name">${d.displayName}</div>
            <div class="user-handle">@${d.nickname}</div>
          </div>
        </a>
      </td>
      <td style="text-align:center">${d.count}</td>
      
      <td>${d.totalView.toLocaleString()}</td>
      <td class="val-highlight">${d.avgView.toLocaleString()}</td>
      
      <td>${d.totalInteraction.toLocaleString()}</td>
      <td class="val-super">${d.avgInteraction.toLocaleString()}</td>
      <td><span class="val-percent" style="background:#fff3cd; color:#664d03">${d.engagementRate}%</span></td>

      <td>${d.totalCmt.toLocaleString()}</td>
      <td class="val-highlight">${d.avgCmt.toLocaleString()}</td>
      
      <td><span class="status-badge status-ok">OK</span></td>
    `;
  }

  function renderTableAll() {
    const tbody = document.querySelector('tbody');
    tbody.innerHTML = '';
    
    resultsData.forEach((d, index) => {
      const tr = document.createElement('tr');
      if(d.status === 'OK') {
        renderSingleRow(tr, {...d, id: index + 1}); 
      } else {
        tr.innerHTML = `<td>${index+1}</td><td>${d.user}</td><td colspan="9" style="color:red">L·ªói: ${d.errorMsg}</td><td>Error</td>`;
      }
      tbody.appendChild(tr);
    });
  }

  window.handleSort = function(colName) {
    if (!resultsData.length) return;

    if (currentSort.col === colName) {
      currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
    } else {
      currentSort.col = colName;
      currentSort.dir = 'desc'; 
    }

    document.querySelectorAll('th.sortable').forEach(th => {
      th.classList.remove('sorted-asc', 'sorted-desc');
    });
    const activeHeader = document.querySelector(`th[onclick*="${colName}"]`);
    if(activeHeader) activeHeader.classList.add(currentSort.dir === 'asc' ? 'sorted-asc' : 'sorted-desc');

    resultsData.sort((a, b) => {
      if (a.status !== 'OK') return 1; 
      if (b.status !== 'OK') return -1;

      let valA = parseFloat(a[colName]);
      let valB = parseFloat(b[colName]);

      if (currentSort.dir === 'asc') {
        return valA - valB;
      } else {
        return valB - valA;
      }
    });

    renderTableAll();
  };

  // === EXPORT EXCEL ===
  document.getElementById('exportBtn').addEventListener('click', () => {
    if (!resultsData.length) return;

    const headers = [
      'User ID', 'Ten Hien Thi',
      'So Video', 
      'Tong View', 'TB View', 
      'Tong Tuong Tac', 'TB Tuong Tac', '% Tuong Tac', 
      'Tong Comment', 'TB Comment', 
      'Trang Thai'
    ];
    
    const rows = resultsData.map(d => {
      if (d.status !== 'OK') return [d.user, '', 0, 0, 0, 0, 0, 0, 0, 0, 'Loi'];
      return [
        d.nickname,
        `"${d.displayName}"`,
        d.count,
        d.totalView, d.avgView,
        d.totalInteraction, d.avgInteraction, `${d.engagementRate}%`,
        d.totalCmt, d.avgCmt,
        'OK'
      ];
    });

    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.setAttribute("download", `TikTok_Lite_V4_${new Date().getTime()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

</script>
</body>
</html>
