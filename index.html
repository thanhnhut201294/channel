<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok Multi-Channel Analyzer</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700&family=Fredoka:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* B·∫£ng m√†u Neubrutalism */
      --primary: #ff0050;      /* H·ªìng TikTok pha ƒë·ªè */
      --secondary: #00f2ea;    /* Xanh Cyan n·ªïi b·∫≠t */
      --bg-color: #f0f4f8;     /* N·ªÅn x√°m xanh nh·∫°t */
      --border-color: #000000; /* Vi·ªÅn ƒëen tuy·ªát ƒë·ªëi */
      --card-bg: #ffffff;
      --text-color: #000000;
      
      /* C·∫•u h√¨nh Shadow & Border chu·∫©n */
      --hard-shadow: 8px 8px 0px var(--border-color);
      --btn-shadow: 3px 3px 0px var(--border-color);
      --input-shadow: 2px 2px 0px var(--border-color);
      --border-thick: 3px solid var(--border-color);
      --border-thin: 2px solid var(--border-color);
      --radius-xl: 15px;
      --radius-md: 10px;
      --radius-sm: 6px;
    }

    body { 
      font-family: 'Be Vietnam Pro', sans-serif; 
      padding: 20px; 
      background: var(--bg-color); 
      color: var(--text-color); 
      background-image: radial-gradient(#000 1px, transparent 1px);
      background-size: 20px 20px; /* H·ªça ti·∫øt ch·∫•m bi nh·ªè cho style ho·∫°t h√¨nh */
    }

    /* N√∫t Quay l·∫°i trang ch·ªß */
    .nav-top {
      max-width: 1280px;
      margin: 0 auto 20px auto;
      display: flex;
    }
    
    .btn-home {
      text-decoration: none;
      background: #ffffff;
      color: var(--text-color);
      font-weight: 700;
      padding: 10px 20px;
      border: var(--border-thin);
      border-radius: var(--radius-md);
      box-shadow: var(--btn-shadow);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .btn-home:hover {
      transform: translate(-2px, -2px);
      box-shadow: 5px 5px 0px var(--border-color);
      background: #fff5bc; /* V√†ng nh·∫°t khi hover */
    }
    .btn-home:active {
      transform: translate(0, 0);
      box-shadow: 1px 1px 0px var(--border-color);
    }

    /* Khung ch√≠nh (Card) */
    main { 
      max-width: 1280px; 
      margin: 0 auto; 
      background: var(--card-bg); 
      padding: 30px; 
      border-radius: var(--radius-xl); 
      border: var(--border-thick);
      box-shadow: var(--hard-shadow);
    }
    
    /* Header Cartoon */
    h1 { 
      font-family: 'Fredoka', sans-serif;
      font-size: 2.5rem;
      margin-top: 0; 
      text-align: center; 
      color: var(--primary); 
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 30px;
      text-shadow: 2px 2px 0px #000; /* Shadow ch·ªØ */
      -webkit-text-stroke: 1px black;
    }
    
    /* Layout Input */
    .control-panel { 
      display: grid; 
      grid-template-columns: 1fr 320px; 
      gap: 25px; 
      margin-bottom: 30px; 
    }
    
    .input-section { display: flex; flex-direction: column; gap: 10px; }
    
    /* Style cho Textarea & Input */
    textarea, input[type="number"] { 
      width: 100%; 
      padding: 15px; 
      border: var(--border-thin); 
      border-radius: var(--radius-md); 
      box-shadow: var(--input-shadow);
      font-family: 'Be Vietnam Pro', monospace; 
      font-size: 15px;
      background: #fff;
      color: #000;
      box-sizing: border-box;
      transition: 0.2s;
    }
    textarea:focus, input:focus { 
      outline: none; 
      background: #f0fbff;
      transform: translate(-1px, -1px);
      box-shadow: 4px 4px 0px var(--border-color);
    }
    textarea { height: 140px; resize: vertical; }
    
    .settings-section { 
      background: #fff5f5; /* N·ªÅn h·ªìng ph·∫•n nh·∫π */
      padding: 20px; 
      border-radius: var(--radius-md); 
      border: var(--border-thin); 
      box-shadow: var(--input-shadow);
      display: flex; 
      flex-direction: column; 
      gap: 15px; 
    }
    
    label { 
      font-family: 'Fredoka', sans-serif;
      font-weight: 600; 
      font-size: 16px; 
      color: #000; 
      display: block; 
      margin-bottom: 8px; 
    }

    /* Buttons Style Neubrutalism */
    .btn-group { display: flex; flex-direction: column; gap: 12px; margin-top: auto; }
    
    button { 
      padding: 12px 20px; 
      border: var(--border-thin); 
      border-radius: var(--radius-md); 
      cursor: pointer; 
      font-weight: 800; 
      font-size: 16px; 
      color: #000; 
      transition: all 0.1s; 
      box-shadow: var(--btn-shadow);
      text-transform: uppercase;
      font-family: 'Be Vietnam Pro', sans-serif;
    }
    
    button:hover:not(:disabled) {
      transform: translate(-2px, -2px);
      box-shadow: 5px 5px 0px var(--border-color);
    }
    button:active:not(:disabled) {
      transform: translate(0, 0);
      box-shadow: 0px 0px 0px var(--border-color);
    }

    #analyzeBtn { background: var(--secondary); } /* Xanh */
    #stopBtn { background: var(--primary); color: #fff; display: none; } /* ƒê·ªè */
    #exportBtn { background: #ffbd00; } /* V√†ng */
    #exportBtn:disabled { background: #e0e0e0; color: #888; cursor: not-allowed; box-shadow: none; transform: none;}

    /* Progress Bar Style Cartoon */
    .progress-container { 
      height: 20px; 
      background: #fff; 
      border: var(--border-thin); 
      border-radius: 20px; 
      margin: 20px 0; 
      overflow: hidden; 
      display: none; 
      box-shadow: var(--input-shadow);
    }
    .progress-bar { 
      height: 100%; 
      background: repeating-linear-gradient(
        45deg,
        var(--secondary),
        var(--secondary) 10px,
        #00c4bd 10px,
        #00c4bd 20px
      );
      width: 0%; 
      transition: width 0.3s ease; 
      border-right: 2px solid #000;
    }

    /* Logger */
    #status { 
      font-family: 'Be Vietnam Pro', monospace; 
      font-weight: 600;
      font-size: 14px; 
      color: #000; 
      margin-bottom: 15px; 
      min-height: 20px; 
      padding: 10px;
      background: #e8e8e8;
      border: 1px solid #000;
      border-radius: 6px;
    }

    /* Table Style Neubrutalism */
    .table-container { 
      overflow-x: auto; 
      border: var(--border-thin); 
      border-radius: var(--radius-md); 
      margin-top: 20px; 
      box-shadow: var(--input-shadow);
      background: #fff;
    }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; font-size: 15px; }
    
    th { 
      background: var(--secondary); 
      color: #000; 
      padding: 15px; 
      text-align: left; 
      white-space: nowrap; 
      position: sticky; 
      top: 0; 
      z-index: 10; 
      border-bottom: var(--border-thin);
      border-right: 1px solid #000;
      font-family: 'Fredoka', sans-serif;
      font-size: 16px;
    }
    
    td { 
      border-bottom: 1px solid #000; 
      border-right: 1px solid #000;
      padding: 12px 15px; 
      vertical-align: middle; 
      color: #000; 
      font-weight: 500;
    }
    td:last-child, th:last-child { border-right: none; }
    
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #fffde7; } /* Hover m√†u v√†ng nh·∫°t */

    /* Specific Column Styles */
    .avatar-cell img { 
      width: 45px; 
      height: 45px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 2px solid #000; 
      vertical-align: middle; 
      margin-right: 10px; 
      background: #fff;
    }
    .metric-high { color: var(--primary); font-weight: 800; }
    .metric-avg { font-weight: 700; color: #0075ff; }
    
    /* Badges */
    .status-badge { 
      padding: 4px 10px; 
      border-radius: 20px; 
      font-size: 12px; 
      font-weight: 800; 
      text-transform: uppercase; 
      border: 2px solid #000;
      box-shadow: 2px 2px 0px rgba(0,0,0,0.2);
    }
    .status-ok { background: #88ff8c; color: #000; }
    .status-err { background: #ff8888; color: #000; }
    .status-wait { background: #fff3cd; color: #000; }

    /* Responsive */
    @media (max-width: 768px) {
      .control-panel { grid-template-columns: 1fr; }
      h1 { font-size: 1.8rem; }
      main { padding: 15px; }
      .btn-group { flex-direction: row; }
    }
  </style>
</head>
<body>

  <div class="nav-top">
    <a href="https://thanhnhut201294.github.io/tool/" class="btn-home">
      <span>‚¨Ö</span> Quay l·∫°i trang ch·ªß
    </a>
  </div>

<main>
  <h1>üìà TikTok Multi-Channel Analyzer</h1>

  <div class="control-panel">
    <div class="input-section">
      <label>Danh s√°ch Link K√™nh ho·∫∑c Username (M·ªói d√≤ng 1 k√™nh)</label>
      <textarea id="channelInput" placeholder="V√≠ d·ª•:&#10;https://www.tiktok.com/@user1&#10;@user2&#10;user3..."></textarea>
    </div>

    <div class="settings-section">
      <div>
        <label>S·ªë l∆∞·ª£ng video c·∫ßn l·∫•y</label>
        <input type="number" id="limitInput" value="10" min="1" max="48">
        <small style="color: #000; font-weight: 600; font-size: 12px; display:block; margin-top:8px">‚ÑπÔ∏è M·∫∑c ƒë·ªãnh 10 video g·∫ßn nh·∫•t ƒë·ªÉ t√≠nh trung b√¨nh (Max 48).</small>
      </div>
      
      <div class="btn-group">
        <button id="analyzeBtn">üöÄ Qu√©t H√†ng Lo·∫°t</button>
        <button id="stopBtn">‚èπ D·ª´ng L·∫°i</button>
        <button id="exportBtn" disabled>üì• Xu·∫•t Excel</button>
      </div>
    </div>
  </div>

  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div id="status">S·∫µn s√†ng ch·ªù l·ªánh...</div>

  <div class="table-container">
    <table id="resultTable">
      <thead>
        <tr>
          <th width="5%">STT</th>
          <th width="25%">K√™nh (User)</th>
          <th width="10%">S·ªë Vid</th>
          <th width="15%">T·ªïng View</th>
          <th width="15%">TB View</th>
          <th width="15%">T·ªïng T∆∞∆°ng T√°c*</th>
          <th width="15%">TB T∆∞∆°ng T√°c</th>
          <th width="10%">Status</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>
  <div style="margin-top: 15px; font-size: 13px; font-weight: bold; color: #555;">
    * T·ªïng T∆∞∆°ng T√°c = Tim + Comment + Share + Save
  </div>
</main>

<script>
  // === LOGIC JAVASCRIPT GI·ªÆ NGUY√äN 100% ===

  // === CONFIG & UTILS ===
  const PROXY_LIST = [
    { url: 'https://api.codetabs.com/v1/proxy?quest=', type: 'direct' },
    { url: 'https://api.allorigins.win/get?url=', type: 'wrapped' },
    { url: 'https://corsproxy.io/?', type: 'direct' }
  ];

  let isRunning = false;
  let resultsData = [];

  function log(msg) {
    document.getElementById('status').textContent = msg;
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  // H√†m tr√≠ch xu·∫•t username t·ª´ link ho·∫∑c text
  function extractUsername(input) {
    input = input.trim();
    try {
      if (input.includes('tiktok.com')) {
        const match = input.match(/@([a-zA-Z0-9_.]+)/);
        return match ? match[1] : null;
      }
      // N·∫øu nh·∫≠p @username
      if (input.startsWith('@')) return input.substring(1);
      // N·∫øu nh·∫≠p username thu·∫ßn
      return input;
    } catch (e) {
      return null;
    }
  }

  // === CORE FETCHING LOGIC ===
  async function smartFetch(targetUrl) {
    for (const proxy of PROXY_LIST) {
      try {
        const finalUrl = proxy.url + encodeURIComponent(targetUrl);
        const res = await fetch(finalUrl);
        if (!res.ok) throw new Error('Network Error');
        
        let data;
        if (proxy.type === 'wrapped') {
          const temp = await res.json();
          if(!temp.contents) throw new Error("No contents");
          data = JSON.parse(temp.contents);
        } else {
          data = await res.json();
        }

        if (data.code === -1) throw new Error("Limit Reached");
        return data; 
      } catch (e) {
        continue;
      }
    }
    throw new Error("Connection failed");
  }

  async function fetchUserVideos(username, limit) {
    const allVideos = [];
    let cursor = 0;
    let hasMore = true;

    // Gi·ªõi h·∫°n c·ª©ng t·ªëi ƒëa 48 ƒë·ªÉ tr√°nh treo
    if (limit > 48) limit = 48;

    while (hasMore && allVideos.length < limit) {
      const targetUrl = `https://www.tikwm.com/api/user/posts?unique_id=${username}&count=33&cursor=${cursor}`;
      const data = await smartFetch(targetUrl);

      if (!data?.data?.videos) {
        if (allVideos.length === 0) throw new Error('Private/Not Found');
        break;
      }

      for (const v of data.data.videos) {
        if (allVideos.length >= limit) break;
        allVideos.push(v);
      }

      cursor = data.data.cursor;
      hasMore = data.data.hasMore;
      if (hasMore) await sleep(1000); // Ngh·ªâ nh·∫π gi·ªØa c√°c trang
    }
    return allVideos;
  }

  // === MAIN LOGIC ===
  document.getElementById('analyzeBtn').addEventListener('click', async () => {
    const inputRaw = document.getElementById('channelInput').value;
    const limit = parseInt(document.getElementById('limitInput').value) || 10;
    
    // L·ªçc danh s√°ch user
    const lines = inputRaw.split('\n').filter(line => line.trim() !== '');
    const usernames = [...new Set(lines.map(extractUsername).filter(u => u))]; // Unique users

    if (usernames.length === 0) return alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 link k√™nh ho·∫∑c username!');

    // Reset UI
    isRunning = true;
    resultsData = [];
    document.querySelector('tbody').innerHTML = '';
    document.getElementById('analyzeBtn').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'inline-block';
    document.getElementById('exportBtn').disabled = true;
    document.querySelector('.progress-container').style.display = 'block';
    updateProgress(0, usernames.length);

    // X·ª≠ l√Ω t·ª´ng user
    for (let i = 0; i < usernames.length; i++) {
      if (!isRunning) break;

      const user = usernames[i];
      log(`‚è≥ ƒêang qu√©t [${i+1}/${usernames.length}]: ${user}...`);
      
      // T·∫°o m·ªôt h√†ng "ƒëang t·∫£i"
      const tr = document.createElement('tr');
      tr.id = `row-${user}`;
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${user}</td>
        <td colspan="6"><span class="status-badge status-wait">ƒêang x·ª≠ l√Ω...</span></td>
      `;
      document.querySelector('tbody').appendChild(tr);

      try {
        const videos = await fetchUserVideos(user, limit);
        const stats = calculateStats(videos);
        
        // L∆∞u d·ªØ li·ªáu ƒë·ªÉ xu·∫•t excel
        resultsData.push({ user, ...stats, status: 'OK' });
        
        // C·∫≠p nh·∫≠t h√†ng ƒë√£ t·∫°o
        updateRowSuccess(tr, user, videos[0]?.author, stats);
        
      } catch (error) {
        // C·∫≠p nh·∫≠t h√†ng l·ªói
        resultsData.push({ user, status: 'Error' });
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${user}</td>
          <td colspan="5" style="color:red; font-weight:bold;">L·ªói: ${error.message}</td>
          <td><span class="status-badge status-err">FAIL</span></td>
        `;
      }

      updateProgress(i + 1, usernames.length);
      
      // Ngh·ªâ gi·ªØa c√°c user ƒë·ªÉ tr√°nh spam API
      if (i < usernames.length - 1) await sleep(1500); 
    }

    finishProcess();
  });

  document.getElementById('stopBtn').addEventListener('click', () => {
    isRunning = false;
    log('‚õî ƒê√£ d·ª´ng b·ªüi ng∆∞·ªùi d√πng.');
    finishProcess();
  });

  function finishProcess() {
    isRunning = false;
    document.getElementById('analyzeBtn').style.display = 'inline-block';
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('exportBtn').disabled = false;
    log('‚úÖ Ho√†n t·∫•t qu√° tr√¨nh qu√©t.');
  }

  function updateProgress(current, total) {
    const percent = (current / total) * 100;
    document.getElementById('progressBar').style.width = `${percent}%`;
  }

  function calculateStats(videos) {
    let totalView = 0, totalLike = 0, totalCmt = 0, totalShare = 0, totalSave = 0;
    
    videos.forEach(v => {
      totalView += (v.play_count || 0);
      totalLike += (v.digg_count || 0);
      totalCmt += (v.comment_count || 0);
      totalShare += (v.share_count || 0);
      totalSave += (v.collect_count || 0);
    });

    const count = videos.length;
    const totalInteraction = totalLike + totalCmt + totalShare + totalSave;
    
    return {
      count,
      totalView,
      avgView: count ? Math.round(totalView / count) : 0,
      totalInteraction,
      avgInteraction: count ? Math.round(totalInteraction / count) : 0,
      avatar: videos[0]?.author?.avatar || '' // L·∫•y avatar t·ª´ video ƒë·∫ßu ti√™n
    };
  }

  function updateRowSuccess(tr, user, authorInfo, stats) {
    const displayName = authorInfo ? authorInfo.nickname : user;
    const avatarUrl = authorInfo ? authorInfo.avatar : '';

    tr.innerHTML = `
      <td>${tr.rowIndex}</td>
      <td class="avatar-cell">
        ${avatarUrl ? `<img src="${avatarUrl}">` : ''}
        <div style="display:inline-block; vertical-align:middle;">
           <strong>${displayName}</strong><br>
           <small style="color:#555">@${user}</small>
        </div>
      </td>
      <td style="text-align:center">${stats.count}</td>
      <td>${stats.totalView.toLocaleString()}</td>
      <td class="metric-avg">${stats.avgView.toLocaleString()}</td>
      <td>${stats.totalInteraction.toLocaleString()}</td>
      <td class="metric-high">${stats.avgInteraction.toLocaleString()}</td>
      <td><span class="status-badge status-ok">OK</span></td>
    `;
  }

  // === EXPORT EXCEL (CSV) ===
  document.getElementById('exportBtn').addEventListener('click', () => {
    if (!resultsData.length) return;

    const headers = ['User ID', 'So Video Quet', 'Tong View', 'TB View', 'Tong Tuong Tac', 'TB Tuong Tac', 'Trang Thai'];
    
    const rows = resultsData.map(d => {
      if (d.status !== 'OK') return [d.user, 0, 0, 0, 0, 0, 'Loi/An'];
      return [
        d.user,
        d.count,
        d.totalView,
        d.avgView,
        d.totalInteraction,
        d.avgInteraction,
        'OK'
      ];
    });

    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.setAttribute("download", `TikTok_Bulk_Analyze_${new Date().getTime()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

</script>
</body>
</html>
