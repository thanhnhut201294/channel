<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TikTok Multi-Channel Analyzer</title>
  <style>
    :root {
      --primary-color: #014a1d;
      --primary-hover: #023816;
      --secondary-color: #218838;
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-color: #333;
      --border-color: #e0e0e0;
    }

    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: var(--bg-color); color: var(--text-color); }
    main { max-width: 1280px; margin: 0 auto; background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    
    /* Header */
    h1 { margin-top: 0; text-align: center; color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 15px; }
    
    /* Layout Input */
    .control-panel { display: grid; grid-template-columns: 1fr 300px; gap: 20px; margin-bottom: 20px; }
    
    .input-section { display: flex; flex-direction: column; gap: 10px; }
    textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; resize: vertical; }
    textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(1, 74, 29, 0.1); }
    
    .settings-section { background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 15px; }
    
    label { font-weight: 700; font-size: 13px; color: var(--primary-color); display: block; margin-bottom: 5px; }
    input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}
    
    /* Buttons */
    .btn-group { display: flex; gap: 10px; margin-top: auto; }
    button { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: #fff; transition: 0.2s; }
    #analyzeBtn { background: var(--primary-color); }
    #analyzeBtn:hover { background: var(--primary-hover); }
    #stopBtn { background: #dc3545; display: none; } 
    #stopBtn:hover { background: #bb2d3b; }
    #exportBtn { background: var(--secondary-color); }
    #exportBtn:disabled { background: #ccc; cursor: not-allowed; }

    /* Progress Bar */
    .progress-container { height: 6px; background: #e9ecef; border-radius: 3px; margin: 15px 0; overflow: hidden; display: none; }
    .progress-bar { height: 100%; background: var(--secondary-color); width: 0%; transition: width 0.3s ease; }

    /* Logger */
    #status { font-family: monospace; font-size: 13px; color: #555; margin-bottom: 10px; min-height: 20px; }

    /* Table */
    .table-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; font-size: 14px; }
    th { background: var(--primary-color); color: #fff; padding: 12px; text-align: left; white-space: nowrap; position: sticky; top: 0; z-index: 10; }
    td { border-bottom: 1px solid #f0f0f0; padding: 10px 12px; vertical-align: middle; color: #333; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #f1f1f1; }

    /* Specific Column Styles */
    .avatar-cell img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; vertical-align: middle; margin-right: 8px; }
    .metric-high { color: #218838; font-weight: bold; }
    .metric-avg { font-weight: 600; color: #0d6efd; }
    .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
    .status-ok { background: #d1e7dd; color: #0f5132; }
    .status-err { background: #f8d7da; color: #842029; }
    .status-wait { background: #fff3cd; color: #664d03; }

    @media (max-width: 768px) {
      .control-panel { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<main>
  <h1>üìà TikTok Multi-Channel Analyzer</h1>

  <div class="control-panel">
    <div class="input-section">
      <label>Danh s√°ch Link K√™nh ho·∫∑c Username (M·ªói d√≤ng 1 k√™nh)</label>
      <textarea id="channelInput" placeholder="https://www.tiktok.com/@user1&#10;@user2&#10;user3..."></textarea>
    </div>

    <div class="settings-section">
      <div>
        <label>S·ªë l∆∞·ª£ng video c·∫ßn l·∫•y (1-48)</label>
        <input type="number" id="limitInput" value="10" min="1" max="48">
        <small style="color: #666; font-size: 11px; display:block; margin-top:5px">M·∫∑c ƒë·ªãnh 10 video g·∫ßn nh·∫•t ƒë·ªÉ t√≠nh trung b√¨nh.</small>
      </div>
      
      <div class="btn-group">
        <button id="analyzeBtn">üöÄ Qu√©t H√†ng Lo·∫°t</button>
        <button id="stopBtn">‚èπ D·ª´ng</button>
        <button id="exportBtn" disabled>üì• Xu·∫•t Excel</button>
      </div>
    </div>
  </div>

  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div id="status">S·∫µn s√†ng ch·ªù l·ªánh...</div>

  <div class="table-container">
    <table id="resultTable">
      <thead>
        <tr>
          <th width="5%">STT</th>
          <th width="20%">K√™nh (User)</th>
          <th width="10%">S·ªë Video</th>
          <th width="15%">T·ªïng View</th>
          <th width="15%">View Trung B√¨nh</th>
          <th width="15%">T·ªïng T∆∞∆°ng T√°c*</th>
          <th width="15%">TB T∆∞∆°ng T√°c</th>
          <th width="5%">Status</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>
  <div style="margin-top: 10px; font-size: 12px; color: #777;">
    * T·ªïng T∆∞∆°ng T√°c = Tim + Comment + Share + Save
  </div>
</main>

<script>
  // === CONFIG & UTILS ===
  const PROXY_LIST = [
    { url: 'https://api.codetabs.com/v1/proxy?quest=', type: 'direct' },
    { url: 'https://api.allorigins.win/get?url=', type: 'wrapped' },
    { url: 'https://corsproxy.io/?', type: 'direct' }
  ];

  let isRunning = false;
  let resultsData = [];

  function log(msg) {
    document.getElementById('status').textContent = msg;
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  // H√†m tr√≠ch xu·∫•t username t·ª´ link ho·∫∑c text
  function extractUsername(input) {
    input = input.trim();
    try {
      if (input.includes('tiktok.com')) {
        const match = input.match(/@([a-zA-Z0-9_.]+)/);
        return match ? match[1] : null;
      }
      // N·∫øu nh·∫≠p @username
      if (input.startsWith('@')) return input.substring(1);
      // N·∫øu nh·∫≠p username thu·∫ßn
      return input;
    } catch (e) {
      return null;
    }
  }

  // === CORE FETCHING LOGIC (Gi·ªØ nguy√™n logic proxy t·ª´ code g·ªëc) ===
  async function smartFetch(targetUrl) {
    for (const proxy of PROXY_LIST) {
      try {
        const finalUrl = proxy.url + encodeURIComponent(targetUrl);
        const res = await fetch(finalUrl);
        if (!res.ok) throw new Error('Network Error');
        
        let data;
        if (proxy.type === 'wrapped') {
          const temp = await res.json();
          if(!temp.contents) throw new Error("No contents");
          data = JSON.parse(temp.contents);
        } else {
          data = await res.json();
        }

        if (data.code === -1) throw new Error("Limit Reached");
        return data; 
      } catch (e) {
        continue;
      }
    }
    throw new Error("Connection failed");
  }

  async function fetchUserVideos(username, limit) {
    const allVideos = [];
    let cursor = 0;
    let hasMore = true;

    // Gi·ªõi h·∫°n c·ª©ng t·ªëi ƒëa 48 ƒë·ªÉ tr√°nh treo
    if (limit > 48) limit = 48;

    while (hasMore && allVideos.length < limit) {
      const targetUrl = `https://www.tikwm.com/api/user/posts?unique_id=${username}&count=33&cursor=${cursor}`;
      const data = await smartFetch(targetUrl);

      if (!data?.data?.videos) {
        if (allVideos.length === 0) throw new Error('Private/Not Found');
        break;
      }

      for (const v of data.data.videos) {
        if (allVideos.length >= limit) break;
        allVideos.push(v);
      }

      cursor = data.data.cursor;
      hasMore = data.data.hasMore;
      if (hasMore) await sleep(1000); // Ngh·ªâ nh·∫π gi·ªØa c√°c trang
    }
    return allVideos;
  }

  // === MAIN LOGIC ===
  document.getElementById('analyzeBtn').addEventListener('click', async () => {
    const inputRaw = document.getElementById('channelInput').value;
    const limit = parseInt(document.getElementById('limitInput').value) || 10;
    
    // L·ªçc danh s√°ch user
    const lines = inputRaw.split('\n').filter(line => line.trim() !== '');
    const usernames = [...new Set(lines.map(extractUsername).filter(u => u))]; // Unique users

    if (usernames.length === 0) return alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 link k√™nh ho·∫∑c username!');

    // Reset UI
    isRunning = true;
    resultsData = [];
    document.querySelector('tbody').innerHTML = '';
    document.getElementById('analyzeBtn').style.display = 'none';
    document.getElementById('stopBtn').style.display = 'inline-block';
    document.getElementById('exportBtn').disabled = true;
    document.querySelector('.progress-container').style.display = 'block';
    updateProgress(0, usernames.length);

    // X·ª≠ l√Ω t·ª´ng user
    for (let i = 0; i < usernames.length; i++) {
      if (!isRunning) break;

      const user = usernames[i];
      log(`‚è≥ ƒêang qu√©t [${i+1}/${usernames.length}]: ${user}...`);
      
      // T·∫°o m·ªôt h√†ng "ƒëang t·∫£i"
      const tr = document.createElement('tr');
      tr.id = `row-${user}`;
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${user}</td>
        <td colspan="6"><span class="status-badge status-wait">ƒêang x·ª≠ l√Ω...</span></td>
      `;
      document.querySelector('tbody').appendChild(tr);

      try {
        const videos = await fetchUserVideos(user, limit);
        const stats = calculateStats(videos);
        
        // L∆∞u d·ªØ li·ªáu ƒë·ªÉ xu·∫•t excel
        resultsData.push({ user, ...stats, status: 'OK' });
        
        // C·∫≠p nh·∫≠t h√†ng ƒë√£ t·∫°o
        updateRowSuccess(tr, user, videos[0]?.author, stats);
        
      } catch (error) {
        // C·∫≠p nh·∫≠t h√†ng l·ªói
        resultsData.push({ user, status: 'Error' });
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${user}</td>
          <td colspan="5" style="color:red">L·ªói: ${error.message}</td>
          <td><span class="status-badge status-err">FAIL</span></td>
        `;
      }

      updateProgress(i + 1, usernames.length);
      
      // Ngh·ªâ gi·ªØa c√°c user ƒë·ªÉ tr√°nh spam API
      if (i < usernames.length - 1) await sleep(1500); 
    }

    finishProcess();
  });

  document.getElementById('stopBtn').addEventListener('click', () => {
    isRunning = false;
    log('‚õî ƒê√£ d·ª´ng b·ªüi ng∆∞·ªùi d√πng.');
    finishProcess();
  });

  function finishProcess() {
    isRunning = false;
    document.getElementById('analyzeBtn').style.display = 'inline-block';
    document.getElementById('stopBtn').style.display = 'none';
    document.getElementById('exportBtn').disabled = false;
    log('‚úÖ Ho√†n t·∫•t qu√° tr√¨nh qu√©t.');
  }

  function updateProgress(current, total) {
    const percent = (current / total) * 100;
    document.getElementById('progressBar').style.width = `${percent}%`;
  }

  function calculateStats(videos) {
    let totalView = 0, totalLike = 0, totalCmt = 0, totalShare = 0, totalSave = 0;
    
    videos.forEach(v => {
      totalView += (v.play_count || 0);
      totalLike += (v.digg_count || 0);
      totalCmt += (v.comment_count || 0);
      totalShare += (v.share_count || 0);
      totalSave += (v.collect_count || 0);
    });

    const count = videos.length;
    const totalInteraction = totalLike + totalCmt + totalShare + totalSave;
    
    return {
      count,
      totalView,
      avgView: count ? Math.round(totalView / count) : 0,
      totalInteraction,
      avgInteraction: count ? Math.round(totalInteraction / count) : 0,
      avatar: videos[0]?.author?.avatar || '' // L·∫•y avatar t·ª´ video ƒë·∫ßu ti√™n
    };
  }

  function updateRowSuccess(tr, user, authorInfo, stats) {
    const displayName = authorInfo ? authorInfo.nickname : user;
    const avatarUrl = authorInfo ? authorInfo.avatar : '';

    tr.innerHTML = `
      <td>${tr.rowIndex}</td>
      <td class="avatar-cell">
        ${avatarUrl ? `<img src="${avatarUrl}">` : ''}
        <div>
           <strong>${displayName}</strong><br>
           <small style="color:#777">@${user}</small>
        </div>
      </td>
      <td style="text-align:center">${stats.count}</td>
      <td>${stats.totalView.toLocaleString()}</td>
      <td class="metric-avg">${stats.avgView.toLocaleString()}</td>
      <td>${stats.totalInteraction.toLocaleString()}</td>
      <td class="metric-high">${stats.avgInteraction.toLocaleString()}</td>
      <td><span class="status-badge status-ok">OK</span></td>
    `;
  }

  // === EXPORT EXCEL (CSV) ===
  document.getElementById('exportBtn').addEventListener('click', () => {
    if (!resultsData.length) return;

    const headers = ['User ID', 'So Video Quet', 'Tong View', 'TB View', 'Tong Tuong Tac', 'TB Tuong Tac', 'Trang Thai'];
    
    const rows = resultsData.map(d => {
      if (d.status !== 'OK') return [d.user, 0, 0, 0, 0, 0, 'Loi/An'];
      return [
        d.user,
        d.count,
        d.totalView,
        d.avgView,
        d.totalInteraction,
        d.avgInteraction,
        'OK'
      ];
    });

    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.setAttribute("download", `TikTok_Bulk_Analyze_${new Date().getTime()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

</script>
</body>
</html>
